name: rpi image builder
on:
  push:
    tags:
      - 'v*'
jobs:
  make-image:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        DISTRO: ["debian", "raspios"]
        SUITE: ["buster", "bullseye"]
        ARCH: ["arm64", "armhf"]
        VARIANT: ["slim", "lite"]
    name: rpi-builder
    steps:
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v1
        with:
          image: tonistiigi/binfmt:latest
          platforms: all
      - uses: actions/checkout@v2
      - name: Build images
        run: |
              sudo apt-get update
              sudo apt-get install debootstrap
              #wget http://ftp.us.debian.org/debian/pool/main/d/debootstrap/debootstrap_1.0.126+nmu1_all.deb
              #wget http://ftp.us.debian.org/debian/pool/main/d/debian-archive-keyring/debian-archive-keyring_2021.1.1_all.deb
              #sudo dpkg -i debootstrap_1.0.126+nmu1_all.deb debian-archive-keyring_2021.1.1_all.deb
              sudo cat <<EOF >/usr/share/debootstrap/scripts/sid
              mirror_style release
              download_style apt
              finddebs_style from-indices
              variants - buildd fakechroot minbase
              keyring $KEYRING
              default_mirror $MIRROR

              # include common settings
              if [ -e "\$DEBOOTSTRAP_DIR/scripts/debian-common" ]; then
               . "\$DEBOOTSTRAP_DIR/scripts/debian-common"
              elif [ -e /debootstrap/debian-common ]; then
               . /debootstrap/debian-common
              elif [ -e "\$DEBOOTSTRAP_DIR/debian-common" ]; then
               . "\$DEBOOTSTRAP_DIR/debian-common"
              else
               error 1 NOCOMMON "File not found: debian-common"
              fi
              EOF
              echo "OS=${{ matrix.DISTRO }}" > config.txt
              echo "ARCHITECTURE=${{ matrix.ARCH }}" >> config.txt
              echo "RELEASE=${{ matrix.SUITE }}" >> config.txt
              echo "VARIANT=${{ matrix.VARIANT }}" >> config.txt
              echo "COMPRESS=xz" >> config.txt
              echo "MANIFEST=true" >> config.txt
              sudo ./rpi-img-builder.sh
              sha256sum ${{ matrix.DISTRO }}-${{ matrix.SUITE }}-${{ matrix.VARIANT }}-${{ matrix.ARCH }}.img.xz \
                > ${{ matrix.DISTRO }}-${{ matrix.SUITE }}-${{ matrix.VARIANT }}-${{ matrix.ARCH }}.img.sha256
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.vars.outputs.tag }}
          draft: false
          files: ${{ matrix.DISTRO }}-${{ matrix.SUITE }}-${{ matrix.VARIANT }}-${{ matrix.ARCH }}.img.*
